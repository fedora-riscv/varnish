Fix for CVE-2015-8852
Based on upstream commit 29870c8fe95e4e8a672f6f28c5fbe692bea09e9c

diff -Naur ../varnish-2.1.5.orig/bin/varnishd/cache_http.c ./bin/varnishd/cache_http.c
--- ../varnish-2.1.5.orig/bin/varnishd/cache_http.c	2011-01-24 22:30:34.000000000 +0100
+++ ./bin/varnishd/cache_http.c	2016-09-08 09:47:04.091793168 +0200
@@ -560,6 +560,39 @@
 
 /*--------------------------------------------------------------------*/
 
+static int
+htc_request_check_hdrs(struct sess *sp, struct http *hp)
+{
+	int u;
+	int seen_host = 0;
+	int seen_cl = 0;
+
+	for (u = HTTP_HDR_FIRST; u < hp->nhd; u++) {
+		if (hp->hd[u].b == NULL)
+			continue;
+		AN(hp->hd[u].b);
+		AN(hp->hd[u].e);
+		if (http_IsHdr(&hp->hd[u], H_Host)) {
+			if (seen_host) {
+				WSP(sp, SLT_Error, "Duplicated Host header");
+				return (400);
+			}
+			seen_host = 1;
+		}
+		if (http_IsHdr(&hp->hd[u], H_Content_Length)) {
+			if (seen_cl) {
+				WSP(sp, SLT_Error,
+				    "Duplicated Content-Length header");
+				return (400);
+			}
+			seen_cl = 1;
+		}
+	}
+	return (0);
+}
+
+/*--------------------------------------------------------------------*/
+
 static void
 http_ProtoVer(struct http *hp)
 {
@@ -597,6 +630,7 @@
 		return (i);
 	}
 	http_ProtoVer(hp);
+	i = htc_request_check_hdrs(sp, hp);
 	return (i);
 }
 
diff -Naur ../varnish-2.1.5.orig/bin/varnishtest/tests/b00041.vtc ./bin/varnishtest/tests/b00041.vtc
--- ../varnish-2.1.5.orig/bin/varnishtest/tests/b00041.vtc	1970-01-01 01:00:00.000000000 +0100
+++ ./bin/varnishtest/tests/b00041.vtc	2016-09-08 10:18:02.920704041 +0200
@@ -0,0 +1,25 @@
+# $Id$
+
+test "Fail request on duplicate Content-Length headers in requests"
+
+server s1 {
+	rxreq
+	txresp
+} -start
+
+varnish v1 -vcl+backend {
+	sub vcl_deliver {
+		if (req.http.foo) {
+			set resp.http.Foo = req.http.foo;
+		}
+		if (req.http.bar) {
+			set resp.http.Bar = req.http.bar;
+		}
+	}
+} -start
+
+client c1 {
+	txreq -req POST -hdr "Content-Length: 5" -body "12345"
+	rxresp
+	expect resp.status == 400
+} -run
diff -Naur ../varnish-2.1.5.orig/bin/varnishtest/tests/r00102.vtc ./bin/varnishtest/tests/r00102.vtc
--- ../varnish-2.1.5.orig/bin/varnishtest/tests/r00102.vtc	2011-01-21 16:13:39.000000000 +0100
+++ ./bin/varnishtest/tests/r00102.vtc	2016-09-08 10:05:29.596959521 +0200
@@ -19,14 +19,12 @@
 
 client c1 {
 	txreq -req POST -url "/" \
-		-hdr "Content-Length: 10" \
 		-body "123456789\n"
 	rxresp
 	expect resp.status == 200
 	expect resp.http.X-Varnish == "1001"
 
 	txreq -req POST -url "/" \
-		-hdr "Content-Length: 10" \
 		-body "123456789\n"
 	rxresp
 	expect resp.status == 200
