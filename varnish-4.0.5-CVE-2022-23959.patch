diff -Naur ../varnish-4.0.5.pre/README ./README
--- ../varnish-4.0.5.pre/README	2017-08-01 11:53:28.000000000 +0200
+++ ./README	2022-02-16 17:37:58.103126495 +0100
@@ -1,5 +1,15 @@
 This is Varnish Cache, the high-performance HTTP accelerator.
 
+SECURITY: The varnish-4.0.x branch is marked END OF LIFE by the Varnish Cache
+upstream project. Please consider upgrading to varnish-6.0 LTS or newer.
+Links to packages compatible with VCL 4.0 and EPEL7 may be found at 
+http://varnish-cache.org/releases/
+
+varnish-4.0.5 is vulnerable to CVE-2022-23959.
+If you are unable to upgrade to a current version of varnish, consider
+mitigating against this attack, see instructions in the included file
+vsv8_epel7_varnish405.vcl
+
 Documentation and additional information about Varnish is available on
 https://www.varnish-cache.org/
 
diff -Naur ../varnish-4.0.5.pre/redhat/varnish_pre ./redhat/varnish_pre
--- ../varnish-4.0.5.pre/redhat/varnish_pre	1970-01-01 01:00:00.000000000 +0100
+++ ./redhat/varnish_pre	2022-02-16 17:37:43.725918807 +0100
@@ -0,0 +1,13 @@
+#!/bin/bash
+
+if /usr/sbin/varnishd -V 2>&1 | head -1 | grep -q 'varnish-4\.0\.'; then
+        if [ -f /etc/varnish/vsv8_epel7_varnish405.vcl ]; then true
+        else
+		echo ""
+                echo "WARNING: CVE-2022-23959 MITIGATION NOT FOUND!"
+		echo "Upgrade to varnish-6.0 LTS or add mitigation"
+                echo "See instructions in /usr/share/doc/varnish-4.0.5/vsv8_epel7_varnish405.vcl"
+		echo ""
+        fi
+fi
+
diff -Naur ../varnish-4.0.5.pre/redhat/varnish_reload_vcl ./redhat/varnish_reload_vcl
--- ../varnish-4.0.5.pre/redhat/varnish_reload_vcl	2022-02-16 17:37:15.285507970 +0100
+++ ./redhat/varnish_reload_vcl	2022-02-16 17:37:43.725918807 +0100
@@ -86,12 +86,12 @@
 	exit 1
 fi
 
-if $VARNISHADM vcl.list | awk ' { print $4 } ' | grep -q $new_config; then
+if $VARNISHADM vcl.list | awk ' { print $3 } ' | grep -q $new_config; then
 	echo Trying to use new config $new_config, but that is already in use
 	exit 2
 fi
 
-current_config=$( $VARNISHADM vcl.list | awk ' /^active/ { print $4 } ' )
+current_config=$( $VARNISHADM vcl.list | awk ' /^active/ { print $3 } ' )
 
 echo "Loading vcl from $VARNISH_VCL_CONF"
 echo "Current running config name is $current_config"
@@ -112,5 +112,6 @@
 fi
 $VARNISHADM vcl.list
 echo Done
+/usr/sbin/varnish_pre
 exit 0
 
diff -Naur ../varnish-4.0.5.pre/redhat/varnish.service ./redhat/varnish.service
--- ../varnish-4.0.5.pre/redhat/varnish.service	2022-02-16 17:37:15.285507970 +0100
+++ ./redhat/varnish.service	2022-02-16 17:37:43.726918822 +0100
@@ -28,6 +28,7 @@
 Type=forking
 PIDFile=/var/run/varnish.pid
 PrivateTmp=true
+ExecStartPre=/usr/sbin/varnish_pre
 ExecStart=/usr/sbin/varnishd \
 	-P /var/run/varnish.pid \
 	-f $VARNISH_VCL_CONF \
diff -Naur ../varnish-4.0.5.pre/redhat/vsv8_epel7_varnish405.vcl ./redhat/vsv8_epel7_varnish405.vcl
--- ../varnish-4.0.5.pre/redhat/vsv8_epel7_varnish405.vcl	1970-01-01 01:00:00.000000000 +0100
+++ ./redhat/vsv8_epel7_varnish405.vcl	2022-02-16 17:37:43.726918822 +0100
@@ -0,0 +1,35 @@
+# VSV00008 Varnish HTTP/1 Request Smuggling Vulnerability
+# also known as CVE-2022-23959
+#
+# Full details on this CVE at http://varnish-cache.org/security/VSV00008.html
+#
+# SECURITY: The varnish-4.0.x branch is marked END OF LIFE by the Varnish Cache
+# upstream project. Please consider upgrading to varnish-6.0 LTS or newer.
+# Links to packages compatible with VCL 4.0 and EPEL7 may be found at 
+# http://varnish-cache.org/releases/
+#
+# varnish-4.0.5 is vulnerable to CVE-2022-23959.
+# If you are unable to upgrade to a current version of varnish, consider
+# mitigating against this attack, by copying this file to
+# /etc/varnish/vsv8_epel7_varnish405.vcl
+# Then near the top of your default.vcl or similar, just below the
+# vcl 4.0; marker, add 
+#
+#    include "vsv8_epel7_varnish405.vcl";
+#
+# The systemd service unit will warn about this vulnerability in the log until
+# that file exists. If you know that your site is not vulnerable to this 
+# attack, you may silence the warning in the log by dropping an empty file at
+# the same location.
+#
+
+sub vsv8_epel7_varnish405 {
+    if ((req.http.Content-Length || req.http.Transfer-Encoding) &&
+      req.proto != "HTTP/2.0") {
+        set resp.http.Connection = "close";
+    }
+}
+
+sub vcl_synth { call vsv8_epel7_varnish405; }
+sub vcl_deliver { call vsv8_epel7_varnish405; }
+
